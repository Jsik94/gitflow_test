# GitHub Flow ì˜µì…˜ - GitHub í‘œì¤€ ë§ì¶¤ ì›Œí¬í”Œë¡œìš°
name: GitHub Flow Branch Validation (Alternative)

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  validate-github-flow:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - name: Validate GitHub Flow Pattern
        uses: actions/github-script@v7
        with:
          script: |
            const { context, github } = require('@actions/github');
            
            const sourceBranch = context.payload.pull_request.head.ref;
            const targetBranch = context.payload.pull_request.base.ref;
            const prTitle = context.payload.pull_request.title;
            
            console.log(`GitHub Flow ê²€ì¦: ${sourceBranch} â†’ ${targetBranch}`);
            
            // GitHub Flow ê·œì¹™ (ëª¨ë“  ê²ƒì´ mainìœ¼ë¡œ)
            const githubFlowRules = {
              // ëª¨ë“  ë¸Œëœì¹˜ â†’ main í—ˆìš© (GitHub í‘œì¤€)
              allowedPatterns: [
                /^feature\//,     // feature/* â†’ main
                /^fix\//,         // fix/* â†’ main  
                /^bugfix\//,      // bugfix/* â†’ main
                /^hotfix\//,      // hotfix/* â†’ main
                /^docs\//,        // docs/* â†’ main
                /^refactor\//,    // refactor/* â†’ main
                /^perf\//,        // perf/* â†’ main
                /^test\//,        // test/* â†’ main
                /^chore\//,       // chore/* â†’ main
                /^release\//,     // release/* â†’ main (í° ë¦´ë¦¬ì¦ˆë§Œ)
              ],
              
              // mainë§Œ íƒ€ê²Ÿìœ¼ë¡œ í—ˆìš©
              allowedTargets: ['main', 'master'],
              
              description: 'GitHub Flow: ëª¨ë“  ë¸Œëœì¹˜ëŠ” mainìœ¼ë¡œë§Œ ë³‘í•© ê°€ëŠ¥'
            };
            
            let isValid = false;
            let message = '';
            
            // GitHub Flow ê²€ì¦
            if (githubFlowRules.allowedTargets.includes(targetBranch)) {
              // ì†ŒìŠ¤ ë¸Œëœì¹˜ íŒ¨í„´ ê²€ì¦
              const isValidSource = githubFlowRules.allowedPatterns.some(pattern => 
                pattern.test(sourceBranch)
              );
              
              if (isValidSource) {
                isValid = true;
                message = `âœ… **GitHub Flow í‘œì¤€ ì¤€ìˆ˜**
            
            **ë¸Œëœì¹˜ ë°©í–¥**: \`${sourceBranch}\` â†’ \`${targetBranch}\`
            **ì „ëµ**: GitHub Flow (GitHub ê³µì‹ ê¶Œì¥)
            **ìƒíƒœ**: ìŠ¹ì¸ë¨
            
            ğŸ’¡ **GitHub Flow ì¥ì **:
            - ë‹¨ìˆœí•˜ê³  ì§ê´€ì ì¸ ì›Œí¬í”Œë¡œìš°
            - ë¹ ë¥¸ ë°°í¬ ê°€ëŠ¥
            - GitHub ì™„ì „ ì§€ì›`;
              } else {
                isValid = false;
                message = `âŒ **ë¸Œëœì¹˜ ì´ë¦„ ê·œì¹™ ìœ„ë°˜**
            
            **ì†ŒìŠ¤ ë¸Œëœì¹˜**: \`${sourceBranch}\`
            **ë¬¸ì œ**: GitHub í‘œì¤€ ë¸Œëœì¹˜ ëª…ëª… ê·œì¹™ì— ë§ì§€ ì•ŠìŒ
            
            **ì˜¬ë°”ë¥¸ ë¸Œëœì¹˜ ì´ë¦„ ì˜ˆì‹œ**:
            - \`feature/user-authentication\`
            - \`fix/login-bug\`
            - \`hotfix/security-patch\`
            - \`docs/update-readme\`
            - \`refactor/api-cleanup\``;
              }
            } else {
              isValid = false;
              message = `âŒ **GitHub Flow ê·œì¹™ ìœ„ë°˜**
            
            **íƒ€ê²Ÿ ë¸Œëœì¹˜**: \`${targetBranch}\`
            **GitHub Flow ê·œì¹™**: ëª¨ë“  ë¸Œëœì¹˜ëŠ” \`main\`ìœ¼ë¡œë§Œ ë³‘í•©
            
            **í•´ê²° ë°©ë²•**:
            1. PR íƒ€ê²Ÿì„ \`main\` ë¸Œëœì¹˜ë¡œ ë³€ê²½
            2. ë˜ëŠ” \`develop\` ë¸Œëœì¹˜ë¥¼ ì œê±°í•˜ê³  GitHub Flow ì±„íƒ`;
            }
            
            // PRì— ì½”ë©˜íŠ¸ ì¶”ê°€
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: message
            });
            
            if (!isValid) {
              console.error(message);
              process.exit(1);
            }
            
      - name: Suggest GitHub Merge Strategy
        uses: actions/github-script@v7
        with:
          script: |
            const { context, github } = require('@actions/github');
            
            const prTitle = context.payload.pull_request.title;
            
            // GitHub ê¶Œì¥ ë¨¸ì§€ ì „ëµ ì œì•ˆ
            let mergeStrategy = 'squash'; // GitHub ê¸°ë³¸ ê¶Œì¥
            let explanation = '';
            
            if (/^(feat|feature)/.test(prTitle)) {
              mergeStrategy = 'squash';
              explanation = 'ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¶”ê°€ - Squash mergeë¡œ ê¹”ë”í•œ íˆìŠ¤í† ë¦¬ ìœ ì§€';
            } else if (/^(fix|bugfix)/.test(prTitle)) {
              mergeStrategy = 'squash';
              explanation = 'ë²„ê·¸ ìˆ˜ì • - Squash mergeë¡œ ìˆ˜ì • íˆìŠ¤í† ë¦¬ ì •ë¦¬';
            } else if (/^hotfix/.test(prTitle)) {
              mergeStrategy = 'merge';
              explanation = 'ê¸´ê¸‰ ìˆ˜ì • - Merge commitìœ¼ë¡œ ëª…í™•í•œ ìˆ˜ì • ê¸°ë¡ ìœ ì§€';
            } else if (/^release/.test(prTitle)) {
              mergeStrategy = 'merge';
              explanation = 'ë¦´ë¦¬ì¦ˆ - Merge commitìœ¼ë¡œ ë¦´ë¦¬ì¦ˆ ì§€ì  ëª…í™• í‘œì‹œ';
            }
            
            const suggestionMessage = `ğŸ”„ **GitHub ê¶Œì¥ ë¨¸ì§€ ì „ëµ**
            
            **ì œì•ˆëœ ì „ëµ**: ${mergeStrategy}
            **ì´ìœ **: ${explanation}
            
            **GitHub ë¨¸ì§€ ì „ëµ ê°€ì´ë“œ**:
            - ğŸ”¸ **Squash and merge**: ê¸°ëŠ¥/ìˆ˜ì • (íˆìŠ¤í† ë¦¬ ì •ë¦¬)
            - ğŸ”¸ **Create merge commit**: ë¦´ë¦¬ì¦ˆ/í•«í”½ìŠ¤ (ëª…í™•í•œ ê¸°ë¡)
            - ğŸ”¸ **Rebase and merge**: ì‘ì€ ìˆ˜ì • (ì„ í˜• íˆìŠ¤í† ë¦¬)`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: suggestionMessage
            });
