name: PR Template Inserter

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  insert-template:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Insert sub-template into PR body
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            (async () => {
              const pr = context.payload.pull_request;
              const prNumber = pr.number;
              const head = pr.head.ref || '';
              const base = pr.base.ref || '';

              // 1) í˜„ì¬ PR ë³¸ë¬¸ ê°€ì ¸ì˜¤ê¸°
              const current = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
              });
              let body = current.data.body || '';

              // 1-a) í† í° ì¹˜í™˜ (í•­ìƒ ìˆ˜í–‰)
              const replaceTokens = (text) =>
                (text || '')
                  .replace(/\{\{HEAD_REF\}\}/g, head)
                  .replace(/\{\{BASE_REF\}\}/g, base);
              body = replaceTokens(body);

              // ì´ë¯¸ ì‚½ì…ëœ í”ì ì´ ìˆìœ¼ë©´ ì¤‘ë³µ ì‚½ì… ë°©ì§€
              const templateMarkers = [
                /<!-- INSERT:TEMPLATE -->/i,
                /###\s+(ğŸ§©|ğŸ›|ğŸš¨|ğŸš€|ğŸ”„)/i,
                /##\s+ë³€ê²½ì‚¬í•­/i,
                /##\s+ì²´í¬ë¦¬ìŠ¤íŠ¸/i,
                /##\s+í…ŒìŠ¤íŠ¸/i,
                /##\s+ê´€ë ¨ ì´ìŠˆ/i,
                /##\s+ì¶”ê°€ ì •ë³´/i,
                /TEMPLATE (\(|\-)/i
              ];
              
              const hasTemplate = templateMarkers.some(marker => marker.test(body));
              
              if (hasTemplate) {
                // ë³¸ë¬¸ë§Œ í† í° ìµœì‹  ê°’ìœ¼ë¡œ ê°±ì‹ 
                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  body,
                });
                console.log('Template already present. Updated tokens only.');
                return;
              }

              // 2) ì²´í¬ë°•ìŠ¤ ì„ íƒ í™•ì¸ (ì‚¬ìš©ì ì„ íƒì´ ìˆìœ¼ë©´ ìš°ì„ )
              const typeMatch = body.match(/- \[x\] *(feature|fix|hotfix|release(?:-backmerge)?)/i);
              let selected = typeMatch ? (typeMatch[1] || '').toLowerCase() : '';

              // 3) í…œí”Œë¦¿ ê²½ë¡œ ê²°ì • (ì„ íƒ > base+head ë§¤í•‘)
              let path = null;
              if (selected) {
                switch (selected) {
                  case 'feature':
                    path = '.github/PULL_REQUEST_TEMPLATE/feature.md';
                    break;
                  case 'fix':
                    path = '.github/PULL_REQUEST_TEMPLATE/fix.md';
                    break;
                  case 'hotfix':
                    path = '.github/PULL_REQUEST_TEMPLATE/hotfix-main.md';
                    break;
                  case 'release':
                    path = '.github/PULL_REQUEST_TEMPLATE/release-main.md';
                    break;
                  case 'release-backmerge':
                    path = '.github/PULL_REQUEST_TEMPLATE/release-backmerge.md';
                    break;
                }
              }

              if (!path) {
                if (/^(main|master)$/i.test(base)) {
                  if (/^hotfix\//i.test(head)) path = '.github/PULL_REQUEST_TEMPLATE/hotfix-main.md';
                  else if (/^release\//i.test(head)) path = '.github/PULL_REQUEST_TEMPLATE/release-main.md';
                  else path = '.github/PULL_REQUEST_TEMPLATE/release-main.md';
                } else if (/^develop(ment)?$/i.test(base)) {
                  if (/^release\//i.test(head)) path = '.github/PULL_REQUEST_TEMPLATE/release-backmerge.md';
                  else if (/^(feature|feat)\//i.test(head)) path = '.github/PULL_REQUEST_TEMPLATE/feature.md';
                  else if (/^(fix|bugfix)\//i.test(head)) path = '.github/PULL_REQUEST_TEMPLATE/fix.md';
                  else path = '.github/PULL_REQUEST_TEMPLATE/feature.md';
                } else {
                  // ê¸°íƒ€ íƒ€ê²Ÿ ë¸Œëœì¹˜: ê¸°ë³¸ê°’ì€ feature
                  if (/^release\//i.test(head)) path = '.github/PULL_REQUEST_TEMPLATE/release-backmerge.md';
                  else if (/^hotfix\//i.test(head)) path = '.github/PULL_REQUEST_TEMPLATE/hotfix-main.md';
                  else if (/^(fix|bugfix)\//i.test(head)) path = '.github/PULL_REQUEST_TEMPLATE/fix.md';
                  else path = '.github/PULL_REQUEST_TEMPLATE/feature.md';
                }
              }

              // 4) í…œí”Œë¦¿ íŒŒì¼ ë¡œë“œ (repoì—ì„œ)
              let template = '';
              try {
                const content = await github.rest.repos.getContent({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  path,
                });
                template = Buffer.from(content.data.content, 'base64').toString('utf8').trim();
              } catch (e) {
                console.log('Template not found, path:', path, 'error:', e.message);
                // í† í°ë§Œ ë°˜ì˜í•´ ì—…ë°ì´íŠ¸
                await github.rest.pulls.update({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  pull_number: prNumber,
                  body,
                });
                return;
              }

              // 5) ì„¼í‹°ë„ ê¸°ì¤€ ì‚½ì… ë˜ëŠ” ë³¸ë¬¸ ëì— ì¶”ê°€
              const sentinel = '<!-- INSERT:TEMPLATE -->';
              if (body.includes(sentinel)) {
                body = body.replace(sentinel, template);
              } else {
                // í…œí”Œë¦¿ì´ ì´ë¯¸ ìˆëŠ”ì§€ í•œ ë²ˆ ë” í™•ì¸
                const hasExistingTemplate = templateMarkers.some(marker => marker.test(body));
                if (!hasExistingTemplate) {
                  body = (body ? body + '\n\n' : '') + template;
                } else {
                  console.log('Template already exists, skipping insertion');
                  return;
                }
              }

              // 5-a) ìµœì¢… ë³¸ë¬¸ì— í† í° í•œ ë²ˆ ë” ì¹˜í™˜
              body = replaceTokens(body);

              // 6) PR ë³¸ë¬¸ ì—…ë°ì´íŠ¸ (ì½”ë©˜íŠ¸ ì—†ì´ ë³¸ë¬¸ë§Œ ë³€ê²½)
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                body,
              });
              console.log('Template inserted from', path, 'for', head, 'â†’', base, 'selected:', selected || '(none)');
            })().catch(e => core.setFailed(e.message));
