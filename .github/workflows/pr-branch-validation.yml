name: PR Branch Direction Validation

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  validate-pr-direction:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - name: Validate Gitflow PR Direction
        uses: actions/github-script@v7
        with:
          script: |
            const { context, github } = require('@actions/github');
            
            const sourceBranch = context.payload.pull_request.head.ref;
            const targetBranch = context.payload.pull_request.base.ref;
            const prTitle = context.payload.pull_request.title;
            
            console.log(`PR: ${sourceBranch} â†’ ${targetBranch}`);
            console.log(`Title: ${prTitle}`);
            
            // Gitflow ë¸Œëžœì¹˜ ë°©í–¥ ê·œì¹™
            const gitflowRules = {
              // Feature ë¸Œëžœì¹˜ â†’ developë§Œ í—ˆìš©
              feature: {
                pattern: /^feature\//,
                allowedTargets: ['develop'],
                description: 'Feature branches can only merge into develop'
              },
              
              // Fix ë¸Œëžœì¹˜ â†’ developë§Œ í—ˆìš©  
              fix: {
                pattern: /^(fix|bugfix)\//,
                allowedTargets: ['develop'],
                description: 'Fix branches can only merge into develop'
              },
              
              // Hotfix ë¸Œëžœì¹˜ â†’ mainë§Œ í—ˆìš©
              hotfix: {
                pattern: /^hotfix\//,
                allowedTargets: ['main', 'master'],
                description: 'Hotfix branches can only merge into main/master'
              },
              
              // Release ë¸Œëžœì¹˜ â†’ main ë˜ëŠ” develop í—ˆìš©
              release: {
                pattern: /^release\//,
                allowedTargets: ['main', 'master', 'develop'],
                description: 'Release branches can merge into main/master or develop'
              },
              
              // Develop â†’ main í—ˆìš© (ìµœì¢… ë¦´ë¦¬ì¦ˆ)
              develop: {
                pattern: /^develop$/,
                allowedTargets: ['main', 'master'],
                description: 'Develop can only merge into main/master'
              },
              
              // Main â†’ develop í—ˆìš© (ë°±ë¨¸ì§€)
              main: {
                pattern: /^(main|master)$/,
                allowedTargets: ['develop'],
                description: 'Main/master can only merge into develop (backmerge)'
              }
            };
            
            let ruleViolated = false;
            let violationMessage = '';
            
            // ë¸Œëžœì¹˜ ê·œì¹™ ê²€ì¦
            for (const [ruleName, rule] of Object.entries(gitflowRules)) {
              if (rule.pattern.test(sourceBranch)) {
                if (!rule.allowedTargets.includes(targetBranch)) {
                  ruleViolated = true;
                  violationMessage = `âŒ **Gitflow ê·œì¹™ ìœ„ë°˜**
            
            **ì†ŒìŠ¤ ë¸Œëžœì¹˜**: \`${sourceBranch}\`
            **íƒ€ê²Ÿ ë¸Œëžœì¹˜**: \`${targetBranch}\`
            **ê·œì¹™**: ${rule.description}
            **í—ˆìš©ëœ íƒ€ê²Ÿ**: ${rule.allowedTargets.join(', ')}
            
            ì˜¬ë°”ë¥¸ ë¸Œëžœì¹˜ ë°©í–¥ìœ¼ë¡œ PRì„ ë‹¤ì‹œ ìƒì„±í•´ì£¼ì„¸ìš”.`;
                  break;
                }
              }
            }
            
            // ì œëª© ê¸°ë°˜ ì¶”ê°€ ê²€ì¦
            const titleValidation = {
              hotfix: {
                pattern: /^hotfix:/,
                requiredTarget: ['main', 'master'],
                message: 'Hotfix ì œëª©ì€ main/master ë¸Œëžœì¹˜ë¡œë§Œ ë³‘í•© ê°€ëŠ¥í•©ë‹ˆë‹¤.'
              },
              release: {
                pattern: /^release:/,
                requiredTarget: ['main', 'master'],
                message: 'Release ì œëª©ì€ main/master ë¸Œëžœì¹˜ë¡œë§Œ ë³‘í•© ê°€ëŠ¥í•©ë‹ˆë‹¤.'
              },
              backmerge: {
                pattern: /^chore\(backmerge\):/,
                requiredTarget: ['develop'],
                message: 'BackmergeëŠ” develop ë¸Œëžœì¹˜ë¡œë§Œ ë³‘í•© ê°€ëŠ¥í•©ë‹ˆë‹¤.'
              }
            };
            
            for (const [type, validation] of Object.entries(titleValidation)) {
              if (validation.pattern.test(prTitle)) {
                if (!validation.requiredTarget.includes(targetBranch)) {
                  ruleViolated = true;
                  violationMessage = `âŒ **ì œëª© ê¸°ë°˜ ë¸Œëžœì¹˜ ê·œì¹™ ìœ„ë°˜**
            
            **PR ì œëª©**: \`${prTitle}\`
            **íƒ€ê²Ÿ ë¸Œëžœì¹˜**: \`${targetBranch}\`
            **í•„ìš”í•œ íƒ€ê²Ÿ**: ${validation.requiredTarget.join(', ')}
            
            ${validation.message}`;
                  break;
                }
              }
            }
            
            if (ruleViolated) {
              // PRì— ì½”ë©˜íŠ¸ ì¶”ê°€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: violationMessage
              });
              
              // ì‹¤íŒ¨ ìƒíƒœ ì„¤ì •
              console.error(violationMessage);
              process.exit(1);
            } else {
              console.log('âœ… Gitflow ë¸Œëžœì¹˜ ë°©í–¥ ê·œì¹™ í†µê³¼');
              
              // ì„±ê³µ ì½”ë©˜íŠ¸ (ì„ íƒì )
              const successMessage = `âœ… **Gitflow ê·œì¹™ ì¤€ìˆ˜**
            
            ë¸Œëžœì¹˜ ë°©í–¥: \`${sourceBranch}\` â†’ \`${targetBranch}\`
            ìƒíƒœ: ìŠ¹ì¸ë¨`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: successMessage
              });
            }
            
      - name: Check Special Cases
        uses: actions/github-script@v7
        with:
          script: |
            const { context } = require('@actions/github');
            
            const sourceBranch = context.payload.pull_request.head.ref;
            const targetBranch = context.payload.pull_request.base.ref;
            
            // íŠ¹ìˆ˜ ì¼€ì´ìŠ¤ ê²½ê³ 
            const warnings = [];
            
            // Release ë¸Œëžœì¹˜ê°€ developìœ¼ë¡œ ë³‘í•©ë˜ëŠ” ê²½ìš° (ë°±ë¨¸ì§€)
            if (/^release\//.test(sourceBranch) && targetBranch === 'develop') {
              warnings.push('âš ï¸ Release ë¸Œëžœì¹˜ë¥¼ developìœ¼ë¡œ ë°±ë¨¸ì§€í•˜ëŠ” ê²½ìš°ìž…ë‹ˆë‹¤. ì¶©ëŒ í•´ê²°ì— ì£¼ì˜í•˜ì„¸ìš”.');
            }
            
            // Mainì—ì„œ developìœ¼ë¡œ ë°±ë¨¸ì§€í•˜ëŠ” ê²½ìš°
            if (/^(main|master)$/.test(sourceBranch) && targetBranch === 'develop') {
              warnings.push('âš ï¸ Main/masterë¥¼ developìœ¼ë¡œ ë°±ë¨¸ì§€í•˜ëŠ” ê²½ìš°ìž…ë‹ˆë‹¤. ë¦´ë¦¬ì¦ˆ ì™„ë£Œ í›„ ì§„í–‰í•˜ì„¸ìš”.');
            }
            
            // ìž¥ê¸°ê°„ ë–¨ì–´ì§„ ë¸Œëžœì¹˜ ê²½ê³  (ì˜ˆì‹œ)
            if (/^feature\//.test(sourceBranch)) {
              warnings.push('ðŸ’¡ Feature ë¸Œëžœì¹˜ìž…ë‹ˆë‹¤. develop ë¸Œëžœì¹˜ì™€ ì¶©ëŒì´ ì—†ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
            }
            
            if (warnings.length > 0) {
              console.log('ê²½ê³ ì‚¬í•­:', warnings.join('\n'));
            }
