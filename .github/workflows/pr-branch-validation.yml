name: PR Branch Direction Validation

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
  workflow_run:
    workflows: ["Auto Labeler"]
    types: [completed]

jobs:
  validate-pr-direction:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - name: Get PR Info
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            let sourceBranch, targetBranch, prTitle, prNumber;
            
            if (context.eventName === 'workflow_run') {
              // workflow_runì—ì„œëŠ” ì›ë³¸ PR ì •ë³´ë¥¼ ê°€ì ¸ì™€ì•¼ í•¨
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`,
                state: 'open'
              });
              
              if (prs.data.length > 0) {
                const pr = prs.data[0];
                sourceBranch = pr.head.ref;
                targetBranch = pr.base.ref;
                prTitle = pr.title;
                prNumber = pr.number;
              } else {
                console.log('No matching PR found for workflow_run');
                return;
              }
            } else {
              // ì§ì ‘ PR ì´ë²¤íŠ¸ì¸ ê²½ìš°
              sourceBranch = context.payload.pull_request.head.ref;
              targetBranch = context.payload.pull_request.base.ref;
              prTitle = context.payload.pull_request.title;
              prNumber = context.payload.pull_request.number;
            }
            
            core.setOutput('source-branch', sourceBranch);
            core.setOutput('target-branch', targetBranch);
            core.setOutput('pr-title', prTitle);
            core.setOutput('pr-number', prNumber);
            
            console.log(`ğŸ” ë¸Œëœì¹˜ ê²€ì¦: ${sourceBranch} â†’ ${targetBranch}`);
        
      - name: Validate Gitflow PR Direction
        if: steps.pr-info.outputs.pr-number
        uses: actions/github-script@v7
        with:
          script: |
            const sourceBranch = '${{ steps.pr-info.outputs.source-branch }}';
            const targetBranch = '${{ steps.pr-info.outputs.target-branch }}';
            const prTitle = '${{ steps.pr-info.outputs.pr-title }}';
            const prNumber = parseInt('${{ steps.pr-info.outputs.pr-number }}');
            
            console.log(`PR: ${sourceBranch} â†’ ${targetBranch}`);
            console.log(`Title: ${prTitle}`);
            
            // Gitflow ë¸Œëœì¹˜ ë°©í–¥ ê·œì¹™
            const gitflowRules = {
              // Feature ë¸Œëœì¹˜ â†’ developë§Œ í—ˆìš©
              feature: {
                pattern: /^feature\//,
                allowedTargets: ['develop'],
                description: 'Feature branches can only merge into develop'
              },
              
              // Fix ë¸Œëœì¹˜ â†’ developë§Œ í—ˆìš©  
              fix: {
                pattern: /^(fix|bugfix)\//,
                allowedTargets: ['develop'],
                description: 'Fix branches can only merge into develop'
              },
              
              // Hotfix ë¸Œëœì¹˜ â†’ mainë§Œ í—ˆìš©
              hotfix: {
                pattern: /^hotfix\//,
                allowedTargets: ['main', 'master'],
                description: 'Hotfix branches can only merge into main/master'
              },
              
              // Release ë¸Œëœì¹˜ â†’ main ë˜ëŠ” develop í—ˆìš©
              release: {
                pattern: /^release\//,
                allowedTargets: ['main', 'master', 'develop'],
                description: 'Release branches can merge into main/master or develop'
              },
              
              // Develop â†’ main í—ˆìš© (ìµœì¢… ë¦´ë¦¬ì¦ˆ)
              develop: {
                pattern: /^develop$/,
                allowedTargets: ['main', 'master'],
                description: 'Develop can only merge into main/master'
              },
              
              // Main â†’ develop í—ˆìš© (ë°±ë¨¸ì§€)
              main: {
                pattern: /^(main|master)$/,
                allowedTargets: ['develop'],
                description: 'Main/master can only merge into develop (backmerge)'
              }
            };
            
            let ruleViolated = false;
            let violationMessage = '';
            
            // ë¸Œëœì¹˜ ê·œì¹™ ê²€ì¦
            for (const [ruleName, rule] of Object.entries(gitflowRules)) {
              if (rule.pattern.test(sourceBranch)) {
                if (!rule.allowedTargets.includes(targetBranch)) {
                  ruleViolated = true;
                  violationMessage = `âŒ **Gitflow ê·œì¹™ ìœ„ë°˜**
            
            **ì†ŒìŠ¤ ë¸Œëœì¹˜**: \`${sourceBranch}\`
            **íƒ€ê²Ÿ ë¸Œëœì¹˜**: \`${targetBranch}\`
            **ê·œì¹™**: ${rule.description}
            **í—ˆìš©ëœ íƒ€ê²Ÿ**: ${rule.allowedTargets.join(', ')}
            
            ì˜¬ë°”ë¥¸ ë¸Œëœì¹˜ ë°©í–¥ìœ¼ë¡œ PRì„ ë‹¤ì‹œ ìƒì„±í•´ì£¼ì„¸ìš”.`;
                  break;
                }
              }
            }
            
            // ì œëª© ê¸°ë°˜ ì¶”ê°€ ê²€ì¦
            const titleValidation = {
              hotfix: {
                pattern: /^hotfix:/,
                requiredTarget: ['main', 'master'],
                message: 'Hotfix ì œëª©ì€ main/master ë¸Œëœì¹˜ë¡œë§Œ ë³‘í•© ê°€ëŠ¥í•©ë‹ˆë‹¤.'
              },
              release: {
                pattern: /^release:/,
                requiredTarget: ['main', 'master'],
                message: 'Release ì œëª©ì€ main/master ë¸Œëœì¹˜ë¡œë§Œ ë³‘í•© ê°€ëŠ¥í•©ë‹ˆë‹¤.'
              },
              backmerge: {
                pattern: /^chore\(backmerge\):/,
                requiredTarget: ['develop'],
                message: 'BackmergeëŠ” develop ë¸Œëœì¹˜ë¡œë§Œ ë³‘í•© ê°€ëŠ¥í•©ë‹ˆë‹¤.'
              }
            };
            
            for (const [type, validation] of Object.entries(titleValidation)) {
              if (validation.pattern.test(prTitle)) {
                if (!validation.requiredTarget.includes(targetBranch)) {
                  ruleViolated = true;
                  violationMessage = `âŒ **ì œëª© ê¸°ë°˜ ë¸Œëœì¹˜ ê·œì¹™ ìœ„ë°˜**
            
            **PR ì œëª©**: \`${prTitle}\`
            **íƒ€ê²Ÿ ë¸Œëœì¹˜**: \`${targetBranch}\`
            **í•„ìš”í•œ íƒ€ê²Ÿ**: ${validation.requiredTarget.join(', ')}
            
            ${validation.message}`;
                  break;
                }
              }
            }
            
            if (ruleViolated) {
              // PRì— ì½”ë©˜íŠ¸ ì¶”ê°€
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: violationMessage
              });
              
              // ì‹¤íŒ¨ ìƒíƒœ ì„¤ì •
              console.error(violationMessage);
              process.exit(1);
            } else {
              console.log('âœ… Gitflow ë¸Œëœì¹˜ ë°©í–¥ ê·œì¹™ í†µê³¼');
              
              // ì„±ê³µ ì½”ë©˜íŠ¸ (ì„ íƒì )
              const successMessage = `âœ… **Gitflow ê·œì¹™ ì¤€ìˆ˜**
            
            ë¸Œëœì¹˜ ë°©í–¥: \`${sourceBranch}\` â†’ \`${targetBranch}\`
            ìƒíƒœ: ìŠ¹ì¸ë¨`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: successMessage
              });
            }
            
      - name: Check Special Cases
        if: steps.pr-info.outputs.pr-number
        uses: actions/github-script@v7
        with:
          script: |
            const sourceBranch = '${{ steps.pr-info.outputs.source-branch }}';
            const targetBranch = '${{ steps.pr-info.outputs.target-branch }}';
            const prNumber = parseInt('${{ steps.pr-info.outputs.pr-number }}');
            
            // íŠ¹ìˆ˜ ì¼€ì´ìŠ¤ ê²½ê³ 
            const warnings = [];
            
            // Release ë¸Œëœì¹˜ê°€ developìœ¼ë¡œ ë³‘í•©ë˜ëŠ” ê²½ìš° (ë°±ë¨¸ì§€)
            if (/^release\//.test(sourceBranch) && targetBranch === 'develop') {
              warnings.push('âš ï¸ Release ë¸Œëœì¹˜ë¥¼ developìœ¼ë¡œ ë°±ë¨¸ì§€í•˜ëŠ” ê²½ìš°ì…ë‹ˆë‹¤. ì¶©ëŒ í•´ê²°ì— ì£¼ì˜í•˜ì„¸ìš”.');
            }
            
            // Mainì—ì„œ developìœ¼ë¡œ ë°±ë¨¸ì§€í•˜ëŠ” ê²½ìš°
            if (/^(main|master)$/.test(sourceBranch) && targetBranch === 'develop') {
              warnings.push('âš ï¸ Main/masterë¥¼ developìœ¼ë¡œ ë°±ë¨¸ì§€í•˜ëŠ” ê²½ìš°ì…ë‹ˆë‹¤. ë¦´ë¦¬ì¦ˆ ì™„ë£Œ í›„ ì§„í–‰í•˜ì„¸ìš”.');
            }
            
            // ì¥ê¸°ê°„ ë–¨ì–´ì§„ ë¸Œëœì¹˜ ê²½ê³  (ì˜ˆì‹œ)
            if (/^feature\//.test(sourceBranch)) {
              warnings.push('ğŸ’¡ Feature ë¸Œëœì¹˜ì…ë‹ˆë‹¤. develop ë¸Œëœì¹˜ì™€ ì¶©ëŒì´ ì—†ëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.');
            }
            
            if (warnings.length > 0) {
              console.log('ê²½ê³ ì‚¬í•­:', warnings.join('\n'));
              
              const warningMessage = `ğŸ“‹ **ì¶”ê°€ ì•ˆë‚´ì‚¬í•­**
              
${warnings.map(w => `- ${w}`).join('\n')}
              
ë¬¸ì œê°€ ìˆë‹¤ë©´ ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.

ğŸ‰ **ëª¨ë“  PR ìë™í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!**`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: warningMessage
              });
            } else {
              // ê²½ê³ ì‚¬í•­ì´ ì—†ëŠ” ê²½ìš°ì—ë„ ì™„ë£Œ ë©”ì‹œì§€
              const completionMessage = `ğŸ‰ **ëª¨ë“  PR ìë™í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!**
              
ëª¨ë“  ê²€ì¦ì„ í†µê³¼í–ˆìŠµë‹ˆë‹¤. ì´ì œ ë¦¬ë·°ë¥¼ ë°›ê³  ë³‘í•©ì„ ì§„í–‰í•˜ì„¸ìš”.`;
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: completionMessage
              });
            }
