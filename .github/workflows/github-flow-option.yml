# GitFlow ì˜µì…˜ - GitFlow í‘œì¤€ ë§ì¶¤ ì›Œí¬í”Œë¡œìš°
name: GitFlow Branch Validation (Alternative)

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  validate-gitflow:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - name: Validate GitFlow Pattern
        uses: actions/github-script@v7
        with:
          script: |
            const sourceBranch = context.payload.pull_request.head.ref;
            const targetBranch = context.payload.pull_request.base.ref;
            const prTitle = context.payload.pull_request.title;
            
            console.log('GitFlow ê²€ì¦:', sourceBranch, 'â†’', targetBranch);
            
            // GitFlow ê·œì¹™ (develop ì¤‘ì‹¬ì˜ ë¸Œëœì¹˜ ì „ëµ)
            const gitflowRules = {
              // GitFlow í‘œì¤€ íŒ¨í„´ë³„ í—ˆìš© íƒ€ê²Ÿ
              allowedPatterns: {
                feature: {
                  pattern: /^feature\//,
                  allowedTargets: ['develop', 'feature'],  // develop ë˜ëŠ” ë‹¤ë¥¸ feature (í˜‘ì—…)
                  description: 'Feature branches merge into develop or other features'
                },
                fix: {
                  pattern: /^(fix|bugfix)\//,
                  allowedTargets: ['develop'],
                  description: 'Fix branches merge into develop'
                },
                hotfix: {
                  pattern: /^hotfix\//,
                  allowedTargets: ['main', 'master', 'develop'],  // main ë¨¼ì €, ê·¸ ë‹¤ìŒ develop
                  description: 'Hotfix branches merge into main/master and develop'
                },
                release: {
                  pattern: /^release\//,
                  allowedTargets: ['main', 'master', 'develop'],  // mainìœ¼ë¡œ ë°°í¬, developìœ¼ë¡œ ë°±ë¨¸ì§€
                  description: 'Release branches merge into main/master and develop'
                },
                develop: {
                  pattern: /^develop$/,
                  allowedTargets: ['release'],  // developì€ release ë¸Œëœì¹˜ ìƒì„±ë§Œ
                  description: 'Develop merges into release branches only'
                }
              },
              
              description: 'GitFlow: develop ì¤‘ì‹¬ì˜ ë¸Œëœì¹˜ ì „ëµ'
            };
            
            let isValid = false;
            let message = '';
            let matchedRule = null;
            
            // GitFlow ê²€ì¦
            for (const [ruleType, rule] of Object.entries(gitflowRules.allowedPatterns)) {
              if (rule.pattern.test(sourceBranch)) {
                matchedRule = rule;
                
                // íƒ€ê²Ÿ ë¸Œëœì¹˜ ì²´í¬ (ì •í™•í•œ ë§¤ì¹­ ë˜ëŠ” íŒ¨í„´ ë§¤ì¹­)
                let targetMatches = false;
                if (ruleType === 'feature' && targetBranch === 'develop') {
                  targetMatches = true;
                } else if (ruleType === 'feature' && /^feature\//.test(targetBranch)) {
                  targetMatches = true; // feature ê°„ í˜‘ì—…
                } else if (rule.allowedTargets.includes(targetBranch)) {
                  targetMatches = true;
                } else if (ruleType === 'develop' && /^release\//.test(targetBranch)) {
                  targetMatches = true; // develop â†’ release/*
                }
                
                if (targetMatches) {
                  isValid = true;
                  message = 'âœ… **GitFlow í‘œì¤€ ì¤€ìˆ˜**\n\n' +
                    '**ë¸Œëœì¹˜ ë°©í–¥**: `' + sourceBranch + '` â†’ `' + targetBranch + '`\n' +
                    '**ì „ëµ**: GitFlow (develop ì¤‘ì‹¬ ë¸Œëœì¹˜ ì „ëµ)\n' +
                    '**ê·œì¹™**: ' + rule.description + '\n' +
                    '**ìƒíƒœ**: ìŠ¹ì¸ë¨\n\n' +
                    'ğŸ’¡ **GitFlow ì¥ì **:\n' +
                    '- ì²´ê³„ì ì¸ ë¦´ë¦¬ì¦ˆ ê´€ë¦¬\n' +
                    '- ì•ˆì •ì ì¸ í”„ë¡œë•ì…˜ ë¸Œëœì¹˜\n' +
                    '- ë³‘ë ¬ ê°œë°œ ì§€ì›';
                } else {
                  isValid = false;
                  message = 'âŒ **GitFlow ê·œì¹™ ìœ„ë°˜**\n\n' +
                    '**ì†ŒìŠ¤ ë¸Œëœì¹˜**: `' + sourceBranch + '`\n' +
                    '**íƒ€ê²Ÿ ë¸Œëœì¹˜**: `' + targetBranch + '`\n' +
                    '**ê·œì¹™**: ' + rule.description + '\n' +
                    '**í—ˆìš©ëœ íƒ€ê²Ÿ**: ' + rule.allowedTargets.join(', ') + '\n\n' +
                    '**í•´ê²° ë°©ë²•**: ì˜¬ë°”ë¥¸ GitFlow íŒ¨í„´ì„ ë”°ë¼ PRì„ ë‹¤ì‹œ ìƒì„±í•˜ì„¸ìš”.';
                }
                break;
              }
            }
            
            // ë§¤ì¹­ë˜ëŠ” ê·œì¹™ì´ ì—†ëŠ” ê²½ìš°
            if (!matchedRule) {
              isValid = false;
              message = 'âŒ **ì•Œ ìˆ˜ ì—†ëŠ” ë¸Œëœì¹˜ íŒ¨í„´**\n\n' +
                '**ì†ŒìŠ¤ ë¸Œëœì¹˜**: `' + sourceBranch + '`\n' +
                '**ë¬¸ì œ**: GitFlow í‘œì¤€ ë¸Œëœì¹˜ ëª…ëª… ê·œì¹™ì— ë§ì§€ ì•ŠìŒ\n\n' +
                '**ì˜¬ë°”ë¥¸ ë¸Œëœì¹˜ ì´ë¦„ ì˜ˆì‹œ**:\n' +
                '- `feature/user-authentication`\n' +
                '- `fix/login-bug`\n' +
                '- `hotfix/security-patch`\n' +
                '- `release/v1.2.0`\n' +
                '- `develop`';
            }
            
            // PRì— ì½”ë©˜íŠ¸ ì¶”ê°€
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: message
            });
            
            if (!isValid) {
              console.error(message);
              process.exit(1);
            }
            
      - name: Suggest GitFlow Merge Strategy
        uses: actions/github-script@v7
        with:
          script: |
            const sourceBranch = context.payload.pull_request.head.ref;
            const targetBranch = context.payload.pull_request.base.ref;
            const prTitle = context.payload.pull_request.title;
            
            // GitFlow ê¶Œì¥ ë¨¸ì§€ ì „ëµ ì œì•ˆ
            let mergeStrategy = 'squash';
            let explanation = '';
            
            if (/^feature\//.test(sourceBranch) && targetBranch === 'develop') {
              mergeStrategy = 'squash';
              explanation = 'Feature â†’ develop: Squash mergeë¡œ ê¹”ë”í•œ ê¸°ëŠ¥ ë‹¨ìœ„ íˆìŠ¤í† ë¦¬ ìœ ì§€';
            } else if (/^feature\//.test(sourceBranch) && /^feature\//.test(targetBranch)) {
              mergeStrategy = 'merge';
              explanation = 'Feature í˜‘ì—…: Merge commitìœ¼ë¡œ í˜‘ì—… ê¸°ë¡ ë³´ì¡´';
            } else if (/^(fix|bugfix)\//.test(sourceBranch) && targetBranch === 'develop') {
              mergeStrategy = 'squash';
              explanation = 'Fix â†’ develop: Squash mergeë¡œ ìˆ˜ì • íˆìŠ¤í† ë¦¬ ì •ë¦¬';
            } else if (/^hotfix\//.test(sourceBranch)) {
              mergeStrategy = 'merge';
              explanation = 'Hotfix: Merge commitìœ¼ë¡œ ê¸´ê¸‰ ìˆ˜ì • ê¸°ë¡ ëª…í™•íˆ ë³´ì¡´';
            } else if (/^release\//.test(sourceBranch)) {
              mergeStrategy = 'merge';
              explanation = 'Release: Merge commitìœ¼ë¡œ ë¦´ë¦¬ì¦ˆ ì§€ì  ëª…í™• í‘œì‹œ';
            } else if (/^develop$/.test(sourceBranch)) {
              mergeStrategy = 'merge';
              explanation = 'Develop â†’ release: Merge commitìœ¼ë¡œ ë¦´ë¦¬ì¦ˆ ì‹œì‘ì  ê¸°ë¡';
            }
            
            const suggestionMessage = 'ğŸ”„ **GitFlow ê¶Œì¥ ë¨¸ì§€ ì „ëµ**\n\n' +
              '**ì œì•ˆëœ ì „ëµ**: ' + mergeStrategy + '\n' +
              '**ì´ìœ **: ' + explanation + '\n\n' +
              '**GitFlow ë¨¸ì§€ ì „ëµ ê°€ì´ë“œ**:\n' +
              '- ğŸ”¸ **Squash and merge**: feature/fix â†’ develop (ê¹”ë”í•œ íˆìŠ¤í† ë¦¬)\n' +
              '- ğŸ”¸ **Create merge commit**: release/hotfix (ëª…í™•í•œ ê¸°ë¡)\n' +
              '- ğŸ”¸ **Merge commit**: ë¸Œëœì¹˜ ê°„ ë³‘í•©ì  ë³´ì¡´ì´ ì¤‘ìš”í•œ ê²½ìš°';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: suggestionMessage
            });
