#!/bin/bash

# Commit-msg hook
# ì»¤ë°‹ ë©”ì‹œì§€ ê²€ì¦ì„ ìœ„í•œ ë©”ì¸ ìŠ¤í¬ë¦½íŠ¸

commit_msg_file="$1"

# í—¬í¼ í•¨ìˆ˜ ë¡œë“œ
script_dir="$(dirname "${BASH_SOURCE[0]}")"
source "$script_dir/helpers/branch.sh"

echo ""
echo "ğŸ“ ================ ì»¤ë°‹ ë©”ì‹œì§€ ê²€ì¦ ================"

# í˜„ì¬ ë¸Œëœì¹˜ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
current_branch=$(get_current_branch)
branch_type=$(get_branch_type "$current_branch")
rule_script=$(get_commit_rule_path "$branch_type")

# ë¸Œëœì¹˜ ì •ë³´ ì¶œë ¥
echo "ğŸŒ¿ í˜„ì¬ ë¸Œëœì¹˜: $current_branch"
echo "ğŸ“‹ ë¸Œëœì¹˜ íƒ€ì…: $branch_type"
echo "ğŸ“ ì ìš© ê·œì¹™: $(basename "$(dirname "$rule_script")")"

# ì»¤ë°‹ ë©”ì‹œì§€ ì½ê¸°
commit_msg=$(cat "$commit_msg_file")
echo "ğŸ’¬ ì»¤ë°‹ ë©”ì‹œì§€: $commit_msg"

echo ""
echo "ğŸ” ë¸Œëœì¹˜ë³„ ê·œì¹™ ê²€ì¦ ì‹œì‘..."

# ë¸Œëœì¹˜ë³„ ê·œì¹™ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
if [ -f "$rule_script" ]; then
    if ! bash "$rule_script" "$commit_msg_file"; then
        echo ""
        echo "âŒ ì»¤ë°‹ ë©”ì‹œì§€ ê²€ì¦ ì‹¤íŒ¨!"
        echo "=================================================="
        exit 1
    fi
else
    echo "âš ï¸  ë¸Œëœì¹˜ë³„ ê·œì¹™ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: $rule_script"
    echo "ğŸ’¡ ê¸°ë³¸ ê·œì¹™ì„ ì ìš©í•©ë‹ˆë‹¤."
    
    # ê¸°ë³¸ ê·œì¹™ (Conventional Commits)
    basic_pattern="^(feat|fix|docs|style|refactor|test|chore|perf)(\(.+\))?: .{1,50}$"
    merge_pattern="^Merge (branch|pull request)"
    
    if [[ ! $commit_msg =~ $basic_pattern ]] && [[ ! $commit_msg =~ $merge_pattern ]]; then
        echo ""
        echo "âŒ ê¸°ë³¸ ì»¤ë°‹ ë©”ì‹œì§€ ê·œì¹™ ìœ„ë°˜!"
        echo "ğŸ“‹ í˜•ì‹: type(scope): description"
        echo "âœ… ì˜ˆì‹œ: feat(auth): ì‚¬ìš©ì ë¡œê·¸ì¸ ê¸°ëŠ¥ ì¶”ê°€"
        exit 1
    fi
fi

echo ""
echo "ğŸ‰ ì»¤ë°‹ ë©”ì‹œì§€ ê²€ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
echo "=================================================="

exit 0
