name: PR Template Selector & Auto Assignment

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  pr-automation:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: PR Template Selection & Auto Assignment
        uses: actions/github-script@v7
        with:
          script: |
            const sourceBranch = context.payload.pull_request.head.ref;
            const targetBranch = context.payload.pull_request.base.ref;
            const prNumber = context.payload.pull_request.number;
            const prTitle = context.payload.pull_request.title;
            const prAuthor = context.payload.pull_request.user.login;
            const isDraft = context.payload.pull_request.draft;
            
            console.log('ğŸ” PR ë¶„ì„:', sourceBranch, 'â†’', targetBranch);
            console.log('ğŸ‘¤ ì‘ì„±ì:', prAuthor);
            console.log('ğŸ“ ì œëª©:', prTitle);
            console.log('ğŸ“‹ Draft:', isDraft);
            
            // 1. í…œí”Œë¦¿ ì„ íƒ ë¡œì§
            let templateFile = '';
            let templateName = '';
            let suggestedTitle = '';
            
            if (/^feature\//.test(sourceBranch) && targetBranch === 'develop') {
              templateFile = '.github/PULL_REQUEST_TEMPLATE/feature.md';
              templateName = 'ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¶”ê°€';
              // ë¸Œëœì¹˜ëª…ì—ì„œ scope ì¶”ì¶œ (feature/client-auth â†’ client)
              const branchName = sourceBranch.replace('feature/', '');
              const scope = branchName.includes('-') ? branchName.split('-')[0] : 'core';
              suggestedTitle = 'feat(' + scope + '): [ìš”ì•½] [TICKET]';
            } else if (/^(fix|bugfix)\//.test(sourceBranch) && targetBranch === 'develop') {
              templateFile = '.github/PULL_REQUEST_TEMPLATE/fix.md';
              templateName = 'ë²„ê·¸ ìˆ˜ì •';
              const branchName = sourceBranch.replace(/^(fix|bugfix)\//, '');
              const scope = branchName.includes('-') ? branchName.split('-')[0] : 'core';
              suggestedTitle = 'fix(' + scope + '): [ìš”ì•½] [TICKET]';
            } else if (/^hotfix\//.test(sourceBranch) && /^(main|master)$/.test(targetBranch)) {
              templateFile = '.github/PULL_REQUEST_TEMPLATE/hotfix-main.md';
              templateName = 'ê¸´ê¸‰ í•«í”½ìŠ¤ (Main)';
              const branchName = sourceBranch.replace('hotfix/', '');
              const scope = branchName.includes('-') ? branchName.split('-')[0] : 'core';
              suggestedTitle = 'fix(' + scope + '): [ê¸´ê¸‰ìˆ˜ì •] [TICKET]';
            } else if (/^release\//.test(sourceBranch) && /^(main|master)$/.test(targetBranch)) {
              templateFile = '.github/PULL_REQUEST_TEMPLATE/release-main.md';
              templateName = 'ë¦´ë¦¬ì¦ˆ (Main)';
              const version = sourceBranch.replace('release/', '');
              suggestedTitle = 'release: ' + version + ' [TICKET]';
            } else if (/^release\//.test(sourceBranch) && targetBranch === 'develop') {
              templateFile = '.github/PULL_REQUEST_TEMPLATE/release-backmerge.md';
              templateName = 'ë¦´ë¦¬ì¦ˆ ë°±ë¨¸ì§€';
              const version = sourceBranch.replace('release/', '');
              suggestedTitle = 'chore(release): backmerge ' + version + ' [TICKET]';
            }

            // 2. CODEOWNERS ê¸°ë°˜ ë¦¬ë·°ì–´ ìë™ í• ë‹¹
            const codeowners = ['jsik94'];
            
            try {
              // í˜„ì¬ í• ë‹¹ëœ ë¦¬ë·°ì–´ í™•ì¸
              const { data: currentReviewers } = await github.rest.pulls.listRequestedReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              
              const currentReviewerLogins = currentReviewers.users.map(user => user.login);
              console.log('ğŸ‘€ í˜„ì¬ ë¦¬ë·°ì–´:', currentReviewerLogins.join(', '));
              
              // ë¦¬ë·°ì–´ê°€ ì—†ê±°ë‚˜ ì‘ì„±ìë§Œ ìˆëŠ” ê²½ìš° ìë™ í• ë‹¹
              const needsReviewers = currentReviewerLogins.length === 0 || 
                                   (currentReviewerLogins.length === 1 && currentReviewerLogins.includes(prAuthor));
              
              if (needsReviewers && !isDraft) {
                const reviewersToAdd = codeowners.filter(reviewer => reviewer !== prAuthor);
                
                if (reviewersToAdd.length > 0) {
                  await github.rest.pulls.requestReviewers({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: prNumber,
                    reviewers: reviewersToAdd
                  });
                  console.log('âœ… ë¦¬ë·°ì–´ ìë™ í• ë‹¹:', reviewersToAdd.join(', '));
                }
              }
              
              // 3. ë‹´ë‹¹ì(Assignee) ìë™ ì„¤ì •
              const { data: currentAssignees } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber
              });
              
              const currentAssigneeLogins = currentAssignees.assignees.map(user => user.login);
              console.log('ğŸ‘¥ í˜„ì¬ ë‹´ë‹¹ì:', currentAssigneeLogins.join(', '));
              
              // ë‹´ë‹¹ìê°€ ì—†ëŠ” ê²½ìš° PR ì‘ì„±ìë¥¼ ë‹´ë‹¹ìë¡œ ì„¤ì •
              if (currentAssigneeLogins.length === 0) {
                await github.rest.issues.addAssignees({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  assignees: [prAuthor]
                });
                console.log('âœ… ë‹´ë‹¹ì ìë™ ì„¤ì •:', prAuthor);
              }

              // 4. í…œí”Œë¦¿ ì ìš© (PRì´ ì²˜ìŒ ìƒì„±ëœ ê²½ìš°ë§Œ)
              if (context.payload.action === 'opened' && templateFile) {
                try {
                  // í…œí”Œë¦¿ íŒŒì¼ ì½ê¸°
                  const { data: templateData } = await github.rest.repos.getContent({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    path: templateFile
                  });
                  
                  const templateContent = Buffer.from(templateData.content, 'base64').toString('utf8');
                  const currentBody = context.payload.pull_request.body || '';
                  
                  // PR ë³¸ë¬¸ì´ ë¹„ì–´ìˆê±°ë‚˜ ë§¤ìš° ì§§ì€ ê²½ìš°ì—ë§Œ í…œí”Œë¦¿ ì ìš©
                  if (currentBody.trim().length < 50) {
                    await github.rest.pulls.update({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      pull_number: prNumber,
                      body: templateContent
                    });
                    console.log('âœ… í…œí”Œë¦¿ ì ìš© ì™„ë£Œ:', templateName);
                  } else {
                    console.log('â­ï¸ í…œí”Œë¦¿ ì ìš© ê±´ë„ˆëœ€: PR ë³¸ë¬¸ì´ ì´ë¯¸ ì‘ì„±ë¨ (' + currentBody.length + 'ì)');
                  }
                } catch (templateError) {
                  console.error('âŒ í…œí”Œë¦¿ ì ìš© ì‹¤íŒ¨:', templateError.message);
                  // í…œí”Œë¦¿ ì ìš© ì‹¤íŒ¨í•´ë„ ì›Œí¬í”Œë¡œìš°ëŠ” ê³„ì† ì§„í–‰
                }
              }

              // 5. ì¢…í•© ìƒíƒœ ì½”ë©˜íŠ¸ (PRì´ ì²˜ìŒ ìƒì„±ëœ ê²½ìš°ë§Œ)
              if (context.payload.action === 'opened') {
                const statusEmojis = {
                  template: templateFile ? 'âœ…' : 'âš ï¸',
                  reviewers: needsReviewers ? 'âœ…' : 'âœ…',
                  assignee: 'âœ…',
                  labels: 'ğŸ”„'
                };

                const templateStatus = templateFile ? templateName : 'ìë™ ì„ íƒ ë¶ˆê°€ (ìˆ˜ë™ ì‘ì„± í•„ìš”)';
                const reviewerStatus = needsReviewers ? '@' + codeowners.filter(r => r !== prAuthor).join(', @') + ' ìë™ í• ë‹¹' : 'ì´ë¯¸ ì„¤ì •ë¨';
                const titleSuggestion = suggestedTitle ? '**ğŸ’¡ ì œëª© ì œì•ˆ**: `' + suggestedTitle + '[ì„¤ëª… ì¶”ê°€]`\n\n' : '';
                const step1 = templateFile ? 'í…œí”Œë¦¿ì— ë§ì¶° PR ì„¤ëª… ì™„ì„±' : 'ì ì ˆí•œ PR ì„¤ëª… ì‘ì„±';
                const step2 = suggestedTitle ? 'ì œëª©ì„ ì œì•ˆëœ í˜•ì‹ìœ¼ë¡œ ë³€ê²½' : 'ì ì ˆí•œ PR ì œëª© ì„¤ì •';
                
                const commentBody = 'ğŸ¤– **PR ìë™ ì„¤ì • ì™„ë£Œ**\n\n' +
                  '**ğŸ“‹ ì„¤ì • ìƒíƒœ**:\n' +
                  statusEmojis.template + ' **í…œí”Œë¦¿**: ' + templateStatus + '\n' +
                  statusEmojis.reviewers + ' **ë¦¬ë·°ì–´**: ' + reviewerStatus + '\n' +
                  statusEmojis.assignee + ' **ë‹´ë‹¹ì**: @' + prAuthor + ' ìë™ ì„¤ì •\n' +
                  statusEmojis.labels + ' **ë¼ë²¨**: ìë™ ë¼ë²¨ëŸ¬ê°€ ê³§ ì ìš©í•  ì˜ˆì •\n\n' +
                  '**ğŸ”€ ë¸Œëœì¹˜**: `' + sourceBranch + '` â†’ `' + targetBranch + '`\n\n' +
                  titleSuggestion +
                  '**ğŸ“ ë‹¤ìŒ ë‹¨ê³„**:\n' +
                  '1. ' + step1 + '\n' +
                  '2. ' + step2 + '\n' +
                  '3. í…ŒìŠ¤íŠ¸ ë° ê²€ì¦ ì™„ë£Œ\n' +
                  '4. ë¦¬ë·° ìš”ì²­\n\n' +
                  '**ğŸ·ï¸ ë¼ë²¨ê³¼ ë¸Œëœì¹˜ ê²€ì¦ì€ ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš°ì—ì„œ ìë™ ì²˜ë¦¬ë©ë‹ˆë‹¤!**';

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: commentBody
                });
              }

            } catch (error) {
              console.error('âŒ PR ìë™ ì„¤ì • ì‹¤íŒ¨:', error.message);
              
              if (context.payload.action === 'opened') {
                const errorBody = 'âš ï¸ **PR ìë™ ì„¤ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ**\n\n' +
                  '**ì˜¤ë¥˜**: ' + error.message + '\n\n' +
                  '**ìˆ˜ë™ ì„¤ì • í•„ìš”**:\n' +
                  '- ë¦¬ë·°ì–´: @jsik94\n' +
                  '- ë‹´ë‹¹ì: @' + prAuthor + '\n' +
                  '- í…œí”Œë¦¿: [ì ì ˆí•œ í…œí”Œë¦¿ ì„ íƒ](../tree/main/.github/PULL_REQUEST_TEMPLATE)\n\n' +
                  'ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.';
                  
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: errorBody
                });
              }
            }
