#!/bin/bash

# Pre-push hook
# í‘¸ì‹œ ì „ì— ì‹¤í–‰ë˜ëŠ” ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ (Nx affected ê¸°ë°˜)

# í—¬í¼ ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
source "$SCRIPT_DIR/helpers/nx-affected.sh"
source "$SCRIPT_DIR/helpers/performance.sh"

echo "ğŸš€ Pre-push ê²€ì¦ ì‹œì‘..."

# ì„±ëŠ¥ ìµœì í™” ì‹œì‘
start_time=$(date +%s)

# í˜„ì¬ ë¸Œëœì¹˜ í™•ì¸
current_branch=$(git rev-parse --abbrev-ref HEAD)
log_info "í˜„ì¬ ë¸Œëœì¹˜: $current_branch"

# ì›ê²© ë¸Œëœì¹˜ì™€ì˜ ì°¨ì´ì  í™•ì¸
remote_branch="origin/$current_branch"
if git rev-parse --verify "$remote_branch" >/dev/null 2>&1; then
    log_info "ì›ê²© ë¸Œëœì¹˜ì™€ ë¹„êµ ì¤‘..."
    base_commit=$(git merge-base HEAD "$remote_branch")
else
    log_info "ìƒˆë¡œìš´ ë¸Œëœì¹˜ì…ë‹ˆë‹¤. main ë¸Œëœì¹˜ì™€ ë¹„êµí•©ë‹ˆë‹¤."
    base_commit=$(git merge-base HEAD origin/main 2>/dev/null || git merge-base HEAD main 2>/dev/null || echo "")
fi

if [ -z "$base_commit" ]; then
    log_warning "ë¹„êµí•  ê¸°ì¤€ ì»¤ë°‹ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ì „ì²´ í”„ë¡œì íŠ¸ë¥¼ ê²€ì¦í•©ë‹ˆë‹¤."
    base_commit="HEAD~1"
fi

log_info "ê¸°ì¤€ ì»¤ë°‹: $base_commit"

# Nx ì›Œí¬ìŠ¤í˜ì´ìŠ¤ ìƒíƒœ í™•ì¸
if ! check_workspace_health; then
    log_error "Nx ì›Œí¬ìŠ¤í˜ì´ìŠ¤ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤."
    exit 1
fi

# Nx affected í”„ë¡œì íŠ¸ í™•ì¸
log_info "Nx affected í”„ë¡œì íŠ¸ ë¶„ì„ ì¤‘..."

# affected í”„ë¡œì íŠ¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
affected_projects=$(get_affected_projects "$base_commit")
affected_apps=$(get_affected_apps "$base_commit")
affected_libs=$(get_affected_libs "$base_commit")

if [ -z "$affected_projects" ]; then
    log_info "ë³€ê²½ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤."
    log_success "Pre-push ê²€ì¦ ì™„ë£Œ!"
    exit 0
fi

# í”„ë¡œì íŠ¸ ìƒì„¸ ì •ë³´ ì¶œë ¥
show_project_details "$affected_projects"

# ì„±ëŠ¥ ìµœì í™” ì‹¤í–‰
log_info "ì„±ëŠ¥ ìµœì í™” ì‹¤í–‰ ì¤‘..."
parallel_count=$(optimize_all "$base_commit" "$affected_projects")

# Nx affected ê²€ì¦ ì‹¤í–‰
log_info "Nx affected ê²€ì¦ ì‹¤í–‰ ì¤‘..."

# 1. ë¦°íŠ¸ ê²€ì‚¬ (affected í”„ë¡œì íŠ¸ë§Œ)
if ! run_affected_command "lint" "$base_commit" "$parallel_count"; then
    log_error "ESLint ê²€ì‚¬ ì‹¤íŒ¨!"
    log_info "ë‹¤ìŒ ëª…ë ¹ì–´ë¡œ ë¬¸ì œë¥¼ ìˆ˜ì •í•´ë³´ì„¸ìš”:"
    log_info "npx nx run-many --target=lint --affected --base=$base_commit --fix"
    exit 1
fi

# 2. íƒ€ì… ì²´í¬ (affected í”„ë¡œì íŠ¸ë§Œ)
if ! run_affected_command "typecheck" "$base_commit" "$parallel_count"; then
    log_error "TypeScript íƒ€ì… ì²´í¬ ì‹¤íŒ¨!"
    log_info "íƒ€ì… ì˜¤ë¥˜ë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ í‘¸ì‹œí•´ì£¼ì„¸ìš”."
    exit 1
fi

# 3. í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (affected í”„ë¡œì íŠ¸ë§Œ)
if ! run_affected_command "test" "$base_commit" "$((parallel_count > 2 ? 2 : parallel_count))"; then
    log_error "í…ŒìŠ¤íŠ¸ ì‹¤í–‰ ì‹¤íŒ¨!"
    log_info "í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í•œ í›„ ë‹¤ì‹œ í‘¸ì‹œí•´ì£¼ì„¸ìš”."
    exit 1
fi

# 4. ë¹Œë“œ ê²€ì¦ (ì•± í”„ë¡œì íŠ¸ê°€ ë³€ê²½ëœ ê²½ìš°ë§Œ)
if [ -n "$affected_apps" ]; then
    log_info "ë¹Œë“œ ê²€ì¦ ì¤‘..."
    if ! run_affected_command "build" "$base_commit" "$((parallel_count > 2 ? 2 : parallel_count))"; then
        log_error "ë¹Œë“œ ì‹¤íŒ¨!"
        log_info "ë¹Œë“œ ì˜¤ë¥˜ë¥¼ ìˆ˜ì •í•œ í›„ ë‹¤ì‹œ í‘¸ì‹œí•´ì£¼ì„¸ìš”."
        exit 1
    fi
fi

# 5. ë¸Œëœì¹˜ë³„ ì¶”ê°€ ê²€ì¦
log_info "ë¸Œëœì¹˜ë³„ ê²€ì¦ ì¤‘..."

# main ë¸Œëœì¹˜ì¸ ê²½ìš° ì¶”ê°€ ê²€ì¦
if [[ "$current_branch" == "main" || "$current_branch" == "master" ]]; then
    log_info "main ë¸Œëœì¹˜ í‘¸ì‹œ - ì „ì²´ í”„ë¡œì íŠ¸ ê²€ì¦"
    # ì „ì²´ í”„ë¡œì íŠ¸ ë¦°íŠ¸ ê²€ì‚¬
    if ! npx nx run-many --target=lint --all --parallel="$parallel_count"; then
        log_error "ì „ì²´ í”„ë¡œì íŠ¸ ë¦°íŠ¸ ê²€ì‚¬ ì‹¤íŒ¨!"
        exit 1
    fi
    log_success "ì „ì²´ í”„ë¡œì íŠ¸ ë¦°íŠ¸ ê²€ì‚¬ í†µê³¼!"
fi

# hotfix ë¸Œëœì¹˜ì¸ ê²½ìš° ë¹ ë¥¸ ê²€ì¦
if [[ "$current_branch" == hotfix/* ]]; then
    log_info "hotfix ë¸Œëœì¹˜ - ë¹ ë¥¸ ê²€ì¦ ëª¨ë“œ"
    # hotfixëŠ” í•µì‹¬ ê²€ì¦ë§Œ ìˆ˜í–‰
    log_success "hotfix ê²€ì¦ ì™„ë£Œ!"
fi

# 6. ì»¤ìŠ¤í…€ ê²€ì¦ ê·œì¹™
log_info "ì»¤ìŠ¤í…€ ê²€ì¦ ê·œì¹™ ì²´í¬ ì¤‘..."

# .husky/helpers/custom-checks.sh ì‹¤í–‰ (ì¡´ì¬í•˜ëŠ” ê²½ìš°)
if [ -f ".husky/helpers/custom-checks.sh" ]; then
    if ! bash .husky/helpers/custom-checks.sh "$affected_projects"; then
        log_error "ì»¤ìŠ¤í…€ ê²€ì¦ ì‹¤íŒ¨!"
        exit 1
    fi
    log_success "ì»¤ìŠ¤í…€ ê²€ì¦ í†µê³¼!"
fi

# ì„±ëŠ¥ ë©”íŠ¸ë¦­ ìˆ˜ì§‘
end_time=$(date +%s)
measure_execution_time "$start_time" "$end_time" "Pre-push ê²€ì¦"

# ì„±ëŠ¥ í†µê³„ ì¶œë ¥
show_performance_stats

log_success "ëª¨ë“  pre-push ê²€ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
log_success "Pre-push ê²€ì¦ í†µê³¼!"

exit 0
