name: PR Template Selector & Auto Assignment

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  pr-automation:
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: read
      issues: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: PR Template Selection & Auto Assignment
        uses: actions/github-script@v7
        with:
          script: |
            const { context, github } = require('@actions/github');
            const fs = require('fs');
            
            const sourceBranch = context.payload.pull_request.head.ref;
            const targetBranch = context.payload.pull_request.base.ref;
            const prNumber = context.payload.pull_request.number;
            const prTitle = context.payload.pull_request.title;
            const prAuthor = context.payload.pull_request.user.login;
            const isDraft = context.payload.pull_request.draft;
            
            console.log(`ğŸ” PR ë¶„ì„: ${sourceBranch} â†’ ${targetBranch}`);
            console.log(`ğŸ‘¤ ì‘ì„±ì: ${prAuthor}`);
            console.log(`ğŸ“ ì œëª©: ${prTitle}`);
            console.log(`ğŸ“‹ Draft: ${isDraft}`);
            
            // 1. í…œí”Œë¦¿ ì„ íƒ ë¡œì§
            let templateFile = '';
            let templateName = '';
            let suggestedTitle = '';
            
            if (/^feature\//.test(sourceBranch) && targetBranch === 'develop') {
              templateFile = '.github/PULL_REQUEST_TEMPLATE/feature.md';
              templateName = 'ìƒˆë¡œìš´ ê¸°ëŠ¥ ì¶”ê°€';
              suggestedTitle = `feat(${sourceBranch.replace('feature/', '')}): `;
            } else if (/^(fix|bugfix)\//.test(sourceBranch) && targetBranch === 'develop') {
              templateFile = '.github/PULL_REQUEST_TEMPLATE/fix.md';
              templateName = 'ë²„ê·¸ ìˆ˜ì •';
              suggestedTitle = `fix(${sourceBranch.replace(/^(fix|bugfix)\//, '')}): `;
            } else if (/^hotfix\//.test(sourceBranch) && /^(main|master)$/.test(targetBranch)) {
              templateFile = '.github/PULL_REQUEST_TEMPLATE/hotfix-main.md';
              templateName = 'ê¸´ê¸‰ í•«í”½ìŠ¤ (Main)';
              suggestedTitle = `hotfix: `;
            } else if (/^release\//.test(sourceBranch) && /^(main|master)$/.test(targetBranch)) {
              templateFile = '.github/PULL_REQUEST_TEMPLATE/release-main.md';
              templateName = 'ë¦´ë¦¬ì¦ˆ (Main)';
              const version = sourceBranch.replace('release/', '');
              suggestedTitle = `release: ${version}`;
            } else if (/^release\//.test(sourceBranch) && targetBranch === 'develop') {
              templateFile = '.github/PULL_REQUEST_TEMPLATE/release-backmerge.md';
              templateName = 'ë¦´ë¦¬ì¦ˆ ë°±ë¨¸ì§€';
              const version = sourceBranch.replace('release/', '');
              suggestedTitle = `chore(backmerge): ${version}`;
            }

            // 2. CODEOWNERS ê¸°ë°˜ ë¦¬ë·°ì–´ ìë™ í• ë‹¹
            const codeowners = ['jsik94'];
            
            try {
              // í˜„ì¬ í• ë‹¹ëœ ë¦¬ë·°ì–´ í™•ì¸
              const { data: currentReviewers } = await github.rest.pulls.listRequestedReviewers({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              
              const currentReviewerLogins = currentReviewers.users.map(user => user.login);
              console.log(`ğŸ‘€ í˜„ì¬ ë¦¬ë·°ì–´: ${currentReviewerLogins.join(', ')}`);
              
              // ë¦¬ë·°ì–´ê°€ ì—†ê±°ë‚˜ ì‘ì„±ìë§Œ ìˆëŠ” ê²½ìš° ìë™ í• ë‹¹
              const needsReviewers = currentReviewerLogins.length === 0 || 
                                   (currentReviewerLogins.length === 1 && currentReviewerLogins.includes(prAuthor));
              
              if (needsReviewers && !isDraft) {
                const reviewersToAdd = codeowners.filter(reviewer => reviewer !== prAuthor);
                
                if (reviewersToAdd.length > 0) {
                  await github.rest.pulls.requestReviewers({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    pull_number: prNumber,
                    reviewers: reviewersToAdd
                  });
                  console.log(`âœ… ë¦¬ë·°ì–´ ìë™ í• ë‹¹: ${reviewersToAdd.join(', ')}`);
                }
              }
              
              // 3. ë‹´ë‹¹ì(Assignee) ìë™ ì„¤ì •
              const { data: currentAssignees } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber
              });
              
              const currentAssigneeLogins = currentAssignees.assignees.map(user => user.login);
              console.log(`ğŸ‘¥ í˜„ì¬ ë‹´ë‹¹ì: ${currentAssigneeLogins.join(', ')}`);
              
              // ë‹´ë‹¹ìê°€ ì—†ëŠ” ê²½ìš° PR ì‘ì„±ìë¥¼ ë‹´ë‹¹ìë¡œ ì„¤ì •
              if (currentAssigneeLogins.length === 0) {
                await github.rest.issues.addAssignees({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  assignees: [prAuthor]
                });
                console.log(`âœ… ë‹´ë‹¹ì ìë™ ì„¤ì •: ${prAuthor}`);
              }

              // 4. í…œí”Œë¦¿ ì ìš© (PRì´ ì²˜ìŒ ìƒì„±ëœ ê²½ìš°ë§Œ)
              if (context.payload.action === 'opened' && templateFile) {
                try {
                  const templateContent = fs.readFileSync(templateFile, 'utf8');
                  const currentBody = context.payload.pull_request.body || '';
                  
                  // PR ë³¸ë¬¸ì´ ë¹„ì–´ìˆê±°ë‚˜ ë§¤ìš° ì§§ì€ ê²½ìš°ì—ë§Œ í…œí”Œë¦¿ ì ìš©
                  if (currentBody.trim().length < 50) {
                    await github.rest.pulls.update({
                      owner: context.repo.owner,
                      repo: context.repo.repo,
                      pull_number: prNumber,
                      body: templateContent
                    });
                    console.log(`âœ… í…œí”Œë¦¿ ì ìš© ì™„ë£Œ: ${templateName}`);
                  }
                } catch (templateError) {
                  console.error(`âŒ í…œí”Œë¦¿ ì ìš© ì‹¤íŒ¨: ${templateError.message}`);
                }
              }

              // 5. ì¢…í•© ìƒíƒœ ì½”ë©˜íŠ¸ (PRì´ ì²˜ìŒ ìƒì„±ëœ ê²½ìš°ë§Œ)
              if (context.payload.action === 'opened') {
                const statusEmojis = {
                  template: templateFile ? 'âœ…' : 'âš ï¸',
                  reviewers: needsReviewers ? 'âœ…' : 'âœ…',
                  assignee: 'âœ…',
                  labels: 'ğŸ”„'
                };

                const commentBody = `ğŸ¤– **PR ìë™ ì„¤ì • ì™„ë£Œ**

**ğŸ“‹ ì„¤ì • ìƒíƒœ**:
${statusEmojis.template} **í…œí”Œë¦¿**: ${templateFile ? templateName : 'ìë™ ì„ íƒ ë¶ˆê°€ (ìˆ˜ë™ ì‘ì„± í•„ìš”)'}
${statusEmojis.reviewers} **ë¦¬ë·°ì–´**: ${needsReviewers ? `@${codeowners.filter(r => r !== prAuthor).join(', @')} ìë™ í• ë‹¹` : 'ì´ë¯¸ ì„¤ì •ë¨'}
${statusEmojis.assignee} **ë‹´ë‹¹ì**: @${prAuthor} ìë™ ì„¤ì •
${statusEmojis.labels} **ë¼ë²¨**: ìë™ ë¼ë²¨ëŸ¬ê°€ ê³§ ì ìš©í•  ì˜ˆì •

**ğŸ”€ ë¸Œëœì¹˜**: \`${sourceBranch}\` â†’ \`${targetBranch}\`

${suggestedTitle ? `**ğŸ’¡ ì œëª© ì œì•ˆ**: \`${suggestedTitle}[ì„¤ëª… ì¶”ê°€]\`` : ''}

**ğŸ“ ë‹¤ìŒ ë‹¨ê³„**:
1. ${templateFile ? 'í…œí”Œë¦¿ì— ë§ì¶° PR ì„¤ëª… ì™„ì„±' : 'ì ì ˆí•œ PR ì„¤ëª… ì‘ì„±'}
2. ${suggestedTitle ? 'ì œëª©ì„ ì œì•ˆëœ í˜•ì‹ìœ¼ë¡œ ë³€ê²½' : 'ì ì ˆí•œ PR ì œëª© ì„¤ì •'}
3. í…ŒìŠ¤íŠ¸ ë° ê²€ì¦ ì™„ë£Œ
4. ë¦¬ë·° ìš”ì²­

**ğŸ·ï¸ ë¼ë²¨ê³¼ ë¸Œëœì¹˜ ê²€ì¦ì€ ë‹¤ë¥¸ ì›Œí¬í”Œë¡œìš°ì—ì„œ ìë™ ì²˜ë¦¬ë©ë‹ˆë‹¤!**`;

                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: commentBody
                });
              }

            } catch (error) {
              console.error(`âŒ PR ìë™ ì„¤ì • ì‹¤íŒ¨: ${error.message}`);
              
              if (context.payload.action === 'opened') {
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: prNumber,
                  body: `âš ï¸ **PR ìë™ ì„¤ì • ì¤‘ ì˜¤ë¥˜ ë°œìƒ**
                  
**ì˜¤ë¥˜**: ${error.message}
                  
**ìˆ˜ë™ ì„¤ì • í•„ìš”**:
- ë¦¬ë·°ì–´: @jsik94 
- ë‹´ë‹¹ì: @${prAuthor}
- í…œí”Œë¦¿: [ì ì ˆí•œ í…œí”Œë¦¿ ì„ íƒ](../tree/main/.github/PULL_REQUEST_TEMPLATE)
                  
ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”.`
                });
              }
            }
