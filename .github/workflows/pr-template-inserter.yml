name: PR Template Inserter

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]

jobs:
  insert-template:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Insert sub-template into PR body
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const prNumber = pr.number;
            const head = pr.head.ref || '';
            const base = pr.base.ref || '';

            // 1) í˜„ì¬ PR ë³¸ë¬¸ ê°€ì ¸ì˜¤ê¸°
            const { data: current } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });
            let body = current.body || '';

            // 1-a) í† í° ì¹˜í™˜ (í•­ìƒ ìˆ˜í–‰)
            const replaceTokens = (text) =>
              (text || '')
                .replace(/\{\{HEAD_REF\}\}/g, head)
                .replace(/\{\{BASE_REF\}\}/g, base);
            body = replaceTokens(body);

            // ì´ë¯¸ ì‚½ì…ëœ í”ì ì´ ìˆìœ¼ë©´ ì¤‘ë³µ ì‚½ì… ë°©ì§€
            if (/TEMPLATE (\(|\-)/i.test(body) || /###\s+(ğŸ§©|ğŸ›|ğŸš¨|ğŸš€|ğŸ”„)/.test(body)) {
              // ë³¸ë¬¸ë§Œ í† í° ìµœì‹  ê°’ìœ¼ë¡œ ê°±ì‹ 
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                body,
              });
              console.log('Template seems present. Updated tokens only.');
              return;
            }

            // 2) í…œí”Œë¦¿ ê²½ë¡œ ê²°ì • (base + head íŒ¨í„´)
            let path = null;
            if (/^(main|master)$/i.test(base)) {
              if (/^hotfix\//i.test(head)) path = '.github/PULL_REQUEST_TEMPLATE/hotfix-main.md';
              else if (/^release\//i.test(head)) path = '.github/PULL_REQUEST_TEMPLATE/release-main.md';
              else path = '.github/PULL_REQUEST_TEMPLATE/release-main.md';
            } else if (/^develop(ment)?$/i.test(base)) {
              if (/^release\//i.test(head)) path = '.github/PULL_REQUEST_TEMPLATE/release-backmerge.md';
              else if (/^(feature|feat)\//i.test(head)) path = '.github/PULL_REQUEST_TEMPLATE/feature.md';
              else if (/^(fix|bugfix)\//i.test(head)) path = '.github/PULL_REQUEST_TEMPLATE/fix.md';
              else path = '.github/PULL_REQUEST_TEMPLATE/feature.md';
            } else {
              // ê¸°íƒ€ íƒ€ê²Ÿ ë¸Œëœì¹˜: ê¸°ë³¸ê°’ì€ feature
              if (/^release\//i.test(head)) path = '.github/PULL_REQUEST_TEMPLATE/release-backmerge.md';
              else if (/^hotfix\//i.test(head)) path = '.github/PULL_REQUEST_TEMPLATE/hotfix-main.md';
              else if (/^(fix|bugfix)\//i.test(head)) path = '.github/PULL_REQUEST_TEMPLATE/fix.md';
              else path = '.github/PULL_REQUEST_TEMPLATE/feature.md';
            }

            // 3) í…œí”Œë¦¿ íŒŒì¼ ë¡œë“œ (repoì—ì„œ)
            let template = '';
            try {
              const { data } = await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path,
              });
              template = Buffer.from(data.content, 'base64').toString('utf8').trim();
            } catch (e) {
              console.log('Template not found, path:', path, 'error:', e.message);
              // í† í°ë§Œ ë°˜ì˜í•´ ì—…ë°ì´íŠ¸
              await github.rest.pulls.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                body,
              });
              return;
            }

            // 4) ì„¼í‹°ë„ ê¸°ì¤€ ì‚½ì… ë˜ëŠ” ë³¸ë¬¸ ëì— ì¶”ê°€ (ì‚½ì… ì „ í…œí”Œë¦¿ì—ë„ í† í° ì¹˜í™˜ ê°€ëŠ¥ì„± ê³ ë ¤ ì‹œ í•„ìš” ì—†ì§€ë§Œ, ì•ˆì „í•˜ê²Œ ê·¸ëŒ€ë¡œ ë‘ )
            const sentinel = '<!-- INSERT:TEMPLATE -->';
            if (body.includes(sentinel)) {
              body = body.replace(sentinel, template);
            } else {
              body = (body ? body + '\n\n' : '') + template;
            }

            // 4-a) ìµœì¢… ë³¸ë¬¸ì— í† í° í•œ ë²ˆ ë” ì¹˜í™˜ (ì•ˆì „ë§)
            body = replaceTokens(body);

            // 5) PR ë³¸ë¬¸ ì—…ë°ì´íŠ¸ (ì½”ë©˜íŠ¸ ì—†ì´ ë³¸ë¬¸ë§Œ ë³€ê²½)
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              body,
            });
            console.log('Template inserted from', path, 'for', head, 'â†’', base);
