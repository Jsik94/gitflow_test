#!/bin/bash

# Pre-push hook (dummy skeleton)
# - nx affected lint
# - nx affected test
# - nx affected build (optional via ENABLE_AFFECTED_BUILD)
# - Prisma validate & migration diff (only if backend affected)

set -euo pipefail

echo "ğŸš€ pre-push ì‹œì‘"

# -------------------------------
# ì„¤ì • (í•„ìš” ì‹œ ìˆ˜ì •)
# -------------------------------
: "${ENABLE_AFFECTED_BUILD:=false}"     # true ë¡œ ì„¤ì •í•˜ë©´ buildë„ ìˆ˜í–‰
: "${BACKEND_TAG:=backend}"             # ë°±ì—”ë“œ ê°ì§€ìš© íƒœê·¸/ì´ë¦„(ì˜ˆ: backend, api, nest ë“±)
: "${NODE_BIN:=npx}"                    # npx/pnpm dlx ë“± ì„ íƒ ê°€ëŠ¥ (ì˜ˆ: pnpm dlx)
: "${NX_HEAD:=HEAD}"

# ì—…ìŠ¤íŠ¸ë¦¼ì´ ì¡´ì¬í•˜ë©´ í•´ë‹¹ ë¸Œëœì¹˜ì™€ì˜ ê³µí†µ ì¡°ìƒì„ baseë¡œ ì‚¬ìš©
if git rev-parse --abbrev-ref --symbolic-full-name @{u} >/dev/null 2>&1; then
  UPSTREAM_REF=$(git rev-parse --abbrev-ref --symbolic-full-name @{u})
  NX_BASE="origin/${UPSTREAM_REF#*/}"
else
  # ì—†ìœ¼ë©´ origin/HEADì™€ì˜ ê³µí†µ ì¡°ìƒ ë˜ëŠ” ì§ì „ ì»¤ë°‹ ì‚¬ìš©
  NX_BASE=$(git merge-base HEAD origin/HEAD 2>/dev/null || echo HEAD~1)
fi

echo "ğŸ” nx affected ë²”ìœ„: base=${NX_BASE} head=${NX_HEAD}"

# -------------------------------
# Affected ëª©ë¡ í™•ì¸ (ì´ë¦„ë§Œ)
# -------------------------------
AFFECTED_PROJECTS=$($NODE_BIN nx print-affected --base "$NX_BASE" --head "$NX_HEAD" --select projects --plain 2>/dev/null || echo "")
echo "ğŸ“¦ affected projects: ${AFFECTED_PROJECTS}"

if [ -z "$AFFECTED_PROJECTS" ]; then
  echo "âœ… ì˜í–¥ë°›ì€ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤. pre-push ì¢…ë£Œ"
  exit 0
fi

# -------------------------------
# Lint (ë”ë¯¸)
# -------------------------------
echo "ğŸ§¹ nx affected lint (ë”ë¯¸)"
echo "[dummy] $NODE_BIN nx affected -t lint --base \"$NX_BASE\" --head \"$NX_HEAD\" --parallel"

# -------------------------------
# Test (ë”ë¯¸)
# -------------------------------
echo "ğŸ§ª nx affected test (ë”ë¯¸)"
echo "[dummy] $NODE_BIN nx affected -t test --base \"$NX_BASE\" --head \"$NX_HEAD\" --parallel --ci"

# -------------------------------
# Build (ì˜µì…˜, ë”ë¯¸)
# -------------------------------
if [ "${ENABLE_AFFECTED_BUILD,,}" = "true" ]; then
  echo "ğŸ—ï¸ nx affected build (ì˜µì…˜ í™œì„±í™”ë¨, ë”ë¯¸)"
  echo "[dummy] $NODE_BIN nx affected -t build --base \"$NX_BASE\" --head \"$NX_HEAD\" --parallel"
else
  echo "â­ï¸ nx affected build ê±´ë„ˆëœ€ (ENABLE_AFFECTED_BUILD=false)"
fi

# -------------------------------
# Prisma (ë°±ì—”ë“œ ì˜í–¥ ì‹œì—ë§Œ, ë”ë¯¸)
# -------------------------------
echo "ğŸ§­ backend ì˜í–¥ íƒì§€ íƒœê·¸: ${BACKEND_TAG}"
if echo "$AFFECTED_PROJECTS" | grep -qi "$BACKEND_TAG"; then
  echo "ğŸ—„ï¸ Prisma validate & migration diff (ë”ë¯¸)"
  echo "[dummy] $NODE_BIN prisma generate && $NODE_BIN prisma validate"
  echo "[dummy] $NODE_BIN prisma migrate diff --from-schema-datamodel ./prisma/schema.prisma --to-url $DATABASE_URL --script"
else
  echo "â­ï¸ backend ì˜í–¥ ì—†ìŒ â†’ Prisma ë‹¨ê³„ ê±´ë„ˆëœ€"
fi

echo "âœ… pre-push ë”ë¯¸ ê²€ì‚¬ ì™„ë£Œ"
exit 0
