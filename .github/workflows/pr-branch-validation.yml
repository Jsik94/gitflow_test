name: PR Branch Direction Validation

on:
  pull_request:
    types: [opened, edited, synchronize, reopened]
  workflow_run:
    workflows: ["Auto Labeler"]
    types: [completed]

jobs:
  validate-pr-direction:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      
    steps:
      - name: Get PR Info
        id: pr-info
        uses: actions/github-script@v7
        with:
          script: |
            let sourceBranch, targetBranch, prTitle, prNumber;
            
            if (context.eventName === 'workflow_run') {
              // workflow_runì—ì„œëŠ” ì›ë³¸ PR ì •ë³´ë¥¼ ê°€ì ¸ì™€ì•¼ í•¨
              const prs = await github.rest.pulls.list({
                owner: context.repo.owner,
                repo: context.repo.repo,
                head: `${context.repo.owner}:${context.payload.workflow_run.head_branch}`,
                state: 'open'
              });
              
              if (prs.data.length > 0) {
                const pr = prs.data[0];
                sourceBranch = pr.head.ref;
                targetBranch = pr.base.ref;
                prTitle = pr.title;
                prNumber = pr.number;
              } else {
                console.log('No matching PR found for workflow_run');
                return;
              }
            } else {
              // ì§ì ‘ PR ì´ë²¤íŠ¸ì¸ ê²½ìš°
              sourceBranch = context.payload.pull_request.head.ref;
              targetBranch = context.payload.pull_request.base.ref;
              prTitle = context.payload.pull_request.title;
              prNumber = context.payload.pull_request.number;
            }
            
            core.setOutput('source-branch', sourceBranch);
            core.setOutput('target-branch', targetBranch);
            core.setOutput('pr-title', prTitle);
            core.setOutput('pr-number', prNumber);
            
            console.log('ğŸ” ë¸Œëœì¹˜ ê²€ì¦:', sourceBranch, 'â†’', targetBranch);
        
      - name: Validate Gitflow PR Direction
        if: steps.pr-info.outputs.pr-number
        uses: actions/github-script@v7
        env:
          SOURCE_BRANCH: ${{ steps.pr-info.outputs.source-branch }}
          TARGET_BRANCH: ${{ steps.pr-info.outputs.target-branch }}
          PR_TITLE: ${{ steps.pr-info.outputs.pr-title }}
          PR_NUMBER: ${{ steps.pr-info.outputs.pr-number }}
        with:
          script: |
            const sourceBranch = process.env.SOURCE_BRANCH;
            const targetBranch = process.env.TARGET_BRANCH;
            const prTitle = process.env.PR_TITLE;
            const prNumber = parseInt(process.env.PR_NUMBER);
            
            console.log('PR:', sourceBranch, 'â†’', targetBranch);
            console.log('Title:', prTitle);
            
            // GitFlow ë¸Œëœì¹˜ ë°©í–¥ ê·œì¹™ (ì™„ì „í•œ ë§¤íŠ¸ë¦­ìŠ¤)
            const gitflowRules = [
              // âœ… ì¼ë°˜ì ìœ¼ë¡œ í—ˆìš©ë˜ëŠ” ë°©í–¥
              { from: /^feature\//, to: ['develop'], status: 'allowed', description: 'ê¸°ëŠ¥ ê°œë°œ ì™„ë£Œ ì‹œ í†µí•©' },
              { from: /^feature\//, to: /^feature\//, status: 'allowed', description: 'ë™ì¼ ê¸°ëŠ¥ ë‚´ ì„œë¸Œë¸Œëœì¹˜ ë¨¸ì§€ (í˜‘ì—… ì‹œ)' },
              { from: /^(fix|bugfix)\//, to: ['develop'], status: 'allowed', description: 'ë²„ê·¸ ìˆ˜ì • ì™„ë£Œ ì‹œ í†µí•©' },
              { from: /^develop$/, to: /^release\//, status: 'allowed', description: 'ë¦´ë¦¬ì¦ˆ ì¤€ë¹„ ì‹œì‘ ì‹œ' },
              { from: /^release\//, to: ['develop'], status: 'allowed', description: 'ë¦´ë¦¬ì¦ˆ ì´í›„ ê°œë°œ ë¸Œëœì¹˜ì— ë°˜ì˜ (ë°±ë¨¸ì§€)' },
              { from: /^release\//, to: ['main', 'master'], status: 'allowed', description: 'ë°°í¬ ìŠ¹ì¸ í›„ í”„ë¡œë•ì…˜ ë°˜ì˜' },
              { from: /^hotfix\//, to: ['main', 'master'], status: 'allowed', description: 'ê¸´ê¸‰ íŒ¨ì¹˜ ë°°í¬' },
              { from: /^hotfix\//, to: ['develop'], status: 'allowed', description: 'í•«í”½ìŠ¤ ë°˜ì˜ í›„ developì—ë„ ì ìš©' },
              
              // âš ï¸ ì œí•œì ìœ¼ë¡œ í—ˆìš© (íŠ¹ìˆ˜ ìƒí™©)
              { from: /^feature\//, to: /^release\//, status: 'warning', description: 'ë¦´ë¦¬ì¦ˆ ë¸Œëœì¹˜ì—ì„œ í•„ìš”í•œ ê¸°ëŠ¥ë§Œ ë³‘í•© (ì œí•œì )' },
              { from: /^develop$/, to: /^feature\//, status: 'warning', description: 'íŠ¹ì • ê¸°ëŠ¥ ë¸Œëœì¹˜ì— ìµœì‹  develop ë°˜ì˜ í•„ìš”í•  ë•Œ (ë“œë¬¼ê²Œ)' },
              { from: /^hotfix\//, to: /^release\//, status: 'warning', description: 'ë¦´ë¦¬ì¦ˆ ì¤€ë¹„ ì¤‘ì¸ ë¸Œëœì¹˜ì—ë„ ì ìš© í•„ìš”í•  ê²½ìš°' },
              
              // âŒ ê¸ˆì§€ëœ ë°©í–¥
              { from: /^feature\//, to: /^hotfix\//, status: 'forbidden', description: 'ì¼ë°˜ì ìœ¼ë¡œ ë¶ˆí•„ìš”' },
              { from: /^feature\//, to: ['main', 'master'], status: 'forbidden', description: 'ì§ì ‘ main ë¨¸ì§€ëŠ” ê¸ˆì§€ (developì„ ê±°ì³ì•¼ í•¨)' },
              { from: /^develop$/, to: /^hotfix\//, status: 'forbidden', description: 'í•«í”½ìŠ¤ëŠ” main ê¸°ë°˜ìœ¼ë¡œ ì§„í–‰' },
              { from: /^develop$/, to: ['main', 'master'], status: 'forbidden', description: 'releaseë¥¼ ê±°ì³ì•¼ main ë¨¸ì§€' },
              { from: /^release\//, to: /^feature\//, status: 'forbidden', description: 'ì˜ë¯¸ ì—†ìŒ' },
              { from: /^hotfix\//, to: /^feature\//, status: 'forbidden', description: 'ì˜ë¯¸ ì—†ìŒ' },
              { from: /^(main|master)$/, to: ['develop'], status: 'forbidden', description: 'release/hotfixë¥¼ í†µí•´ ê°„ì ‘ ë°˜ì˜í•´ì•¼ í•¨' }
            ];
            
            let status = 'unknown';
            let matchedRule = null;
            let statusMessage = '';
            
            // ë¸Œëœì¹˜ ê·œì¹™ ê²€ì¦
            for (const rule of gitflowRules) {
              let sourceMatches = false;
              let targetMatches = false;
              
              // ì†ŒìŠ¤ ë¸Œëœì¹˜ ë§¤ì¹­
              sourceMatches = rule.from.test(sourceBranch);
              
              // íƒ€ê²Ÿ ë¸Œëœì¹˜ ë§¤ì¹­
              if (Array.isArray(rule.to)) {
                targetMatches = rule.to.includes(targetBranch);
              } else if (rule.to instanceof RegExp) {
                targetMatches = rule.to.test(targetBranch);
              }
              
              if (sourceMatches && targetMatches) {
                status = rule.status;
                matchedRule = rule;
                break;
              }
            }
            
            // ê²°ê³¼ì— ë”°ë¥¸ ë©”ì‹œì§€ ìƒì„±
            if (status === 'allowed') {
              statusMessage = 'âœ… **GitFlow ê·œì¹™ ì¤€ìˆ˜**\n\n' +
                '**ë¸Œëœì¹˜ ë°©í–¥**: `' + sourceBranch + '` â†’ `' + targetBranch + '`\n' +
                '**ìƒíƒœ**: ìŠ¹ì¸ë¨\n' +
                '**ì„¤ëª…**: ' + matchedRule.description + '\n\n' +
                'ğŸ‰ ì˜¬ë°”ë¥¸ GitFlow íŒ¨í„´ì…ë‹ˆë‹¤!';
            } else if (status === 'warning') {
              statusMessage = 'âš ï¸ **GitFlow íŠ¹ìˆ˜ ì¼€ì´ìŠ¤**\n\n' +
                '**ë¸Œëœì¹˜ ë°©í–¥**: `' + sourceBranch + '` â†’ `' + targetBranch + '`\n' +
                '**ìƒíƒœ**: ì œí•œì  í—ˆìš©\n' +
                '**ì„¤ëª…**: ' + matchedRule.description + '\n\n' +
                '**ì£¼ì˜ì‚¬í•­**: ì´ ë³‘í•©ì´ ì •ë§ í•„ìš”í•œì§€ ë‹¤ì‹œ í•œë²ˆ í™•ì¸í•˜ì„¸ìš”.\n' +
                'íŒ€ ë¦¬ë“œ ë˜ëŠ” ì‹œë‹ˆì–´ ê°œë°œìì˜ ìŠ¹ì¸ì„ ë°›ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.';
            } else if (status === 'forbidden') {
              statusMessage = 'âŒ **GitFlow ê·œì¹™ ìœ„ë°˜**\n\n' +
                '**ë¸Œëœì¹˜ ë°©í–¥**: `' + sourceBranch + '` â†’ `' + targetBranch + '`\n' +
                '**ìƒíƒœ**: ê¸ˆì§€ë¨\n' +
                '**ì´ìœ **: ' + matchedRule.description + '\n\n' +
                '**í•´ê²° ë°©ë²•**: ì˜¬ë°”ë¥¸ GitFlow íŒ¨í„´ì„ ë”°ë¼ PRì„ ë‹¤ì‹œ ìƒì„±í•˜ì„¸ìš”.';
            } else {
              statusMessage = 'â“ **ì•Œ ìˆ˜ ì—†ëŠ” ë¸Œëœì¹˜ íŒ¨í„´**\n\n' +
                '**ë¸Œëœì¹˜ ë°©í–¥**: `' + sourceBranch + '` â†’ `' + targetBranch + '`\n' +
                '**ìƒíƒœ**: ë¯¸ì •ì˜ëœ íŒ¨í„´\n\n' +
                '**ê¶Œì¥ì‚¬í•­**: í‘œì¤€ GitFlow ë¸Œëœì¹˜ ëª…ëª… ê·œì¹™ì„ ì‚¬ìš©í•˜ì„¸ìš”.\n' +
                '- feature/*, fix/*, hotfix/*, release/*, develop, main';
            }
            
            // PRì— ì½”ë©˜íŠ¸ ì¶”ê°€
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: statusMessage
            });
            
            // ìƒíƒœì— ë”°ë¥¸ ì›Œí¬í”Œë¡œìš° ì²˜ë¦¬
            if (status === 'forbidden') {
              console.error('GitFlow ê·œì¹™ ìœ„ë°˜:', statusMessage);
              process.exit(1);
            } else if (status === 'warning') {
              console.log('GitFlow íŠ¹ìˆ˜ ì¼€ì´ìŠ¤ ê°ì§€:', statusMessage);
              // ê²½ê³ ëŠ” í†µê³¼ì‹œí‚¤ë˜ ë¡œê·¸ì— ê¸°ë¡
            } else if (status === 'allowed') {
              console.log('âœ… GitFlow ê·œì¹™ ì¤€ìˆ˜');
            } else {
              console.log('âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” íŒ¨í„´ì´ì§€ë§Œ í†µê³¼ì‹œí‚´');
            }
            
      - name: Check Special Cases
        if: steps.pr-info.outputs.pr-number
        uses: actions/github-script@v7
        env:
          SOURCE_BRANCH: ${{ steps.pr-info.outputs.source-branch }}
          TARGET_BRANCH: ${{ steps.pr-info.outputs.target-branch }}
          PR_NUMBER: ${{ steps.pr-info.outputs.pr-number }}
        with:
          script: |
            const sourceBranch = process.env.SOURCE_BRANCH;
            const targetBranch = process.env.TARGET_BRANCH;
            const prNumber = parseInt(process.env.PR_NUMBER);
            
            // GitFlow íŠ¹ìˆ˜ ì¼€ì´ìŠ¤ ë° ê¶Œì¥ì‚¬í•­
            const recommendations = [];
            
            // Release ë°±ë¨¸ì§€ ê¶Œì¥ì‚¬í•­
            if (/^release\//.test(sourceBranch) && targetBranch === 'develop') {
              recommendations.push('ğŸ”„ **Release ë°±ë¨¸ì§€ ì²´í¬ë¦¬ìŠ¤íŠ¸**:\n' +
                '- [ ] í”„ë¡œë•ì…˜ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆëŠ”ì§€ í™•ì¸\n' +
                '- [ ] ë¦´ë¦¬ì¦ˆ ë…¸íŠ¸ê°€ ì‘ì„±ë˜ì—ˆëŠ”ì§€ í™•ì¸\n' +
                '- [ ] ì¶©ëŒ í•´ê²° ì‹œ í…ŒìŠ¤íŠ¸ ì¬ì§„í–‰');
            }
            
            // Hotfix ë‹¤ì¤‘ ë³‘í•© ê¶Œì¥ì‚¬í•­
            if (/^hotfix\//.test(sourceBranch)) {
              recommendations.push('ğŸš¨ **Hotfix ë‹¤ì¤‘ ë³‘í•© ì²´í¬ë¦¬ìŠ¤íŠ¸**:\n' +
                '- [ ] main/master ë¸Œëœì¹˜ì— ë¨¼ì € ë³‘í•© ì™„ë£Œ\n' +
                '- [ ] develop ë¸Œëœì¹˜ì—ë„ ë™ì¼í•œ ìˆ˜ì • ì ìš© ì˜ˆì •\n' +
                '- [ ] í˜„ì¬ ì§„í–‰ ì¤‘ì¸ release ë¸Œëœì¹˜ê°€ ìˆë‹¤ë©´ í•´ë‹¹ ë¸Œëœì¹˜ì—ë„ ì ìš© ê³ ë ¤');
            }
            
            // Feature ë¸Œëœì¹˜ ê¶Œì¥ì‚¬í•­
            if (/^feature\//.test(sourceBranch) && targetBranch === 'develop') {
              recommendations.push('âœ¨ **Feature ë³‘í•© ì²´í¬ë¦¬ìŠ¤íŠ¸**:\n' +
                '- [ ] ìµœì‹  develop ë¸Œëœì¹˜ì™€ ì¶©ëŒ ì—†ëŠ”ì§€ í™•ì¸\n' +
                '- [ ] ê¸°ëŠ¥ í…ŒìŠ¤íŠ¸ ì™„ë£Œ\n' +
                '- [ ] ì½”ë“œ ë¦¬ë·° ì™„ë£Œ\n' +
                '- [ ] ê´€ë ¨ ë¬¸ì„œ ì—…ë°ì´íŠ¸');
            }
            
            // Feature ê°„ ë³‘í•© (í˜‘ì—…)
            if (/^feature\//.test(sourceBranch) && /^feature\//.test(targetBranch)) {
              recommendations.push('ğŸ¤ **Feature ê°„ í˜‘ì—… ë³‘í•©**:\n' +
                '- [ ] ë™ì¼í•œ ê¸°ëŠ¥ ì˜ì—­ì¸ì§€ í™•ì¸\n' +
                '- [ ] íƒ€ê²Ÿ feature ë¸Œëœì¹˜ ì†Œìœ ìì˜ ìŠ¹ì¸ í•„ìš”\n' +
                '- [ ] ìµœì¢…ì ìœ¼ë¡œëŠ” developìœ¼ë¡œ ë³‘í•© ì˜ˆì •');
            }
            
            if (recommendations.length > 0) {
              console.log('GitFlow ê¶Œì¥ì‚¬í•­:', recommendations.length + 'ê°œ');
              
              const recommendationMessage = 'ğŸ“‹ **GitFlow ê¶Œì¥ì‚¬í•­**\n\n' +
                recommendations.join('\n\n') + '\n\n' +
                'ğŸ’¡ **ì°¸ê³ **: ì´ëŠ” ê¶Œì¥ì‚¬í•­ì´ë©°, í”„ë¡œì íŠ¸ ìƒí™©ì— ë§ê²Œ ì¡°ì •í•˜ì„¸ìš”.\n\n' +
                'ğŸ‰ **ëª¨ë“  PR ìë™í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!**';
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: recommendationMessage
              });
            } else {
              // ê¶Œì¥ì‚¬í•­ì´ ì—†ëŠ” ê²½ìš°ì—ë„ ì™„ë£Œ ë©”ì‹œì§€
              const completionMessage = 'ğŸ‰ **ëª¨ë“  PR ìë™í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!**\n\n' +
                'ëª¨ë“  GitFlow ê²€ì¦ì„ í†µê³¼í–ˆìŠµë‹ˆë‹¤. ì´ì œ ë¦¬ë·°ë¥¼ ë°›ê³  ë³‘í•©ì„ ì§„í–‰í•˜ì„¸ìš”.';
              
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body: completionMessage
              });
            }
